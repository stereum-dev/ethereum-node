---
- name: Verify
  hosts: all
  gather_facts: false
  tasks:
  - stat: path=/etc/stereum/services
    register: stereum_services_dir
  - debug:
      msg: "{{ stereum_services_dir }}"
  # ufw
  - shell: ufw status
    register: stereum_ufw_status
  - debug:
      msg: "{{ stereum_ufw_status }}"
  - assert:
      that:
      - stereum_ufw_status.stdout.find("12000/udp") != -1
      - stereum_ufw_status.stdout.find("13000/tcp") != -1
      - stereum_ufw_status.stdout.find("4000/tcp") != -1
      - stereum_ufw_status.stdout.find("7500/tcp") != -1
  # Wallet & auth-token
  - stat: path=/opt/app/services/0d4a2d58-b417-11ec-a0f3-0b91f10c3a8c/data/wallets/direct/accounts/all-accounts.keystore.json
    register: validator_all_accounts
  - debug:
      msg: "{{ validator_all_accounts }}"
  - name: Check for validator wallet
    assert:
      that:
        - validator_all_accounts.stat.exists
  - stat: path=/opt/app/services/0d4a2d58-b417-11ec-a0f3-0b91f10c3a8c/data/wallets/auth-token
    register: auth_token
  - debug:
      msg: "{{ auth_token }}"
  - name: Check for api-token
    assert:
      that:
        - auth_token.stat.exists
  - name: Waiting for the services to start properly
    pause:
      minutes: 3
  # prysm beacon & validator logs
  - name: prysm beacon node
    command: "docker logs --tail=100 stereum-40a39644-b417-11ec-9917-3f1fbdf72a3a"
    register: beacon
    until:
      - beacon.stderr is search('estimated time remaining')
      - beacon.stderr is not search('Could not connect to execution endpoint')
    retries: 360
    delay: 10
  - name: prysm validator
    command: "docker logs stereum-0d4a2d58-b417-11ec-a0f3-0b91f10c3a8c"
    register: validator
    until:
      - validator.stderr is search('Reloaded validator keys into keymanager')
      - validator.stderr is search('Beacon chain started')
      - validator.stderr is not search('Could not determine if beacon chain started')
    retries: 360
    delay: 10
  # container's images & ports
  - shell: docker ps
    register: stereum_docker_ps
  - debug:
      msg: "{{ stereum_docker_ps }}"
  - assert:
      that:
      - stereum_docker_ps.stdout.find("prysmaticlabs/prysm-validator") != -1
      - stereum_docker_ps.stdout.find("prysmaticlabs/prysm-beacon-chain") != -1
      - stereum_docker_ps.stdout.find("7500->7500") != -1
      - stereum_docker_ps.stdout.find("4000->4000") != -1
      - stereum_docker_ps.stdout.find("12000->12000") != -1
      - stereum_docker_ps.stdout.find("13000->13000") != -1
      - (stereum_docker_ps.stdout|regex_findall("Up")|length) == 2
