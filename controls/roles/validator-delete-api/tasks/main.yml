---
- block:
  - name: Prysm - Get validator service's api token
    command: "docker exec -u 0 -w /opt/app/data/wallets stereum-{{ validator_service }} cat auth-token"
    changed_when: false
    register: auth_token
    become: yes
  - name: Print out auth_token
    debug:
      msg: "{{ auth_token.stdout_lines[1] }}"
  - name: Get api-token
    set_fact:
      api_token: "{{ auth_token.stdout_lines[1] }}"
  - name: Print out api_token
    debug:
      msg: "{{ api_token }}"
  - name: Prysm delete-validator using API
    uri:
      url: http://localhost:7500/eth/v1/keystores
      headers:
        Content-Type: application/json
        Authorization: "Bearer {{ api_token }}"
      method: DELETE
      body:
        pubkeys: "{{ item.key }}"
      body_format: json
    become: yes
    with_items: "{{ validator_public_keys }}"
  when: consClient == "prysm"

- block:
  - name: Lighthouse - Get validator service's api token
    command: "docker exec -u 0 -w /opt/app/validator/validators stereum-{{ validator_service }} cat api-token.txt"
    changed_when: false
    register: api_token
    become: yes
  - name: Print out api_token
    debug:
      msg: "{{ api_token.stdout }}"
  - name: Lighthouse delete-validator using API
    uri:
      url: http://localhost:5062/eth/v1/keystores
      headers:
        Content-Type: application/json
        Authorization: "Bearer {{ api_token.stdout }}"
      method: DELETE
      body:
        pubkeys: "{{ item.key }}"
      body_format: json
    become: yes
    with_items: "{{ validator_public_keys }}"
  when: consClient == "lighthouse"

- block:
  - name: Nimbus - Get validator service's api token
    command: "docker exec -u 0 -w /opt/app/validators stereum-{{ beacon_service }} cat api-token.txt"
    changed_when: false
    register: api_token
    become: yes
  - name: Print out api_token
    debug:
      msg: "{{ api_token.stdout }}"
  - name: Nimbus delete-validator using API
    uri:
      url: http://localhost:5052/eth/v1/keystores/delete
      headers:
        Content-Type: application/json
        Authorization: "Bearer {{ api_token.stdout }}"
      method: POST
      body:
        pubkeys: ["{{ item.key }}"]
      body_format: json
    become: yes
    with_items: "{{ validator_public_keys }}"
  when: consClient == "nimbus"

- block:
  - name: Teku - Get validator service's api token
    command: "docker exec -u 0 -w /opt/app/data/validator/key-manager stereum-{{ beacon_service }} cat validator-api-bearer"
    changed_when: false
    register: api_token
    become: yes
  - name: Print out api_token
    debug:
      msg: "{{ api_token.stdout }}"
  - name: Teku delete-validator using API
    uri:
      url: https://localhost:5052/eth/v1/keystores
      validate_certs: no
      headers:
        Content-Type: application/json
        Authorization: "Bearer {{ api_token.stdout }}"
      method: DELETE
      body:
        pubkeys: "{{ item.key }}"
      body_format: json
    become: yes
    with_items: "{{ validator_public_keys }}"
  when: consClient == "teku"
